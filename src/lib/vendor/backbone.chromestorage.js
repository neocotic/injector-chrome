/*! Backbone.ChromeStorage | (c) 2012 Alexandra Grey | MIT License */
(function(a){if(typeof define==='function'&&define.amd)define(['jquery','underscore','backbone'],a);else a(this.$,this._,this.Backbone)}(function(i,e,f){'use strict';function l(a){a=''+a||'local';if(!chrome.storage[a]){console.warn('Unknown type %s, defaulting to local',a);a='local'}this.type=a;this.storage=chrome.storage[this.type]}function p(b){return function(){var a=chrome.runtime.lastError;if(!a)b.resolve.apply(b,arguments);else{console.warn("chromeStorage error: '%s'",a.message);b.reject(b,a.message,a)}}}function q(c){return function(a){var b=i.Deferred();if(typeof a==='function')b.done(a);this.storage[c](p(b));return b.promise()}}function m(h){return function(a,b){var c=i.Deferred();if(typeof b==='function')c.done(b);this.storage[h](a,p(c));return c.promise()}}e(l.prototype).extend({getBytesInUse:q('getBytesInUse'),clear:q('clear'),get:m('get'),set:m('set'),remove:m('remove'),getQuotaObject:function(){return e(this.storage).pick('QUOTA_BYTES','QUOTA_BYTES_PER_ITEM','MAX_ITEMS','MAX_SUSTAINED_WRITE_OPERATIONS_PER_MINUTE','MAX_WRITE_OPERATIONS_PER_HOUR')}});function j(b,c){e.bindAll(this);this.name=b;this.type=c||j.defaultType||'local';this.store=new l(this.type);this.loaded=this.store.get(this.name).pipe(this._2).done((function(a){this.records=a;chrome.storage.onChanged.addListener(this.updateRecords.bind(this))}).bind(this))}j.defaultType='local';function n(a){return function(){return a.toJSON()}}function g(){return(((1+Math.random())*0x10000)|0).toString(16).substring(1)}function s(){return(g()+g()+"-"+g()+"-"+g()+"-"+g()+"-"+g()+g()+g())}e(j.prototype).extend({updateRecords:function(a,b){var c=a[this.name];if(this._3(c,b)){this._4(c.newValue)}},_3:function(a,b){return b===this.type&&a&&a.newValue!==this._5()},_4:function(a){this.records=a.split(',')},_5:function(){return this.records.join(',')},create:function(a){if(!a.id){a.id=s();a.set(a.idAttribute,a.id)}return this.store.set(this._1(a),this._6.bind(this,a)).pipe(n(a))},_6:function(a){this.records.push(''+a.id);this.save()},update:function(a){return this.store.set(this._1(a),this._7.bind(this,a)).pipe(n(a))},_7:function(a){var b=''+a.id;if(!e(this.records).include(b)){this.records.push(b);this.save()}},find:function(a){return this.store.get(this._1(a)).pipe(this._8.bind(this,a))},_8:function(a,b){return JSON.parse(b[this._0(a)])},findAll:function(){var c=i.Deferred(),h=c.resolve.bind(c);i.when(this.loaded).done((function(a){var b=this._9();this.store.get(b,h)}).bind(this));return c.pipe(this._a)},_a:function(a){return e(a).map(JSON.parse)},destroy:function(a){return this.store.remove(this._0(a),this._b.bind(this,a)).pipe(n(a))},_b:function(a){this.records=e.without(this.records,a.id);this.save()},quota:function(){var b=this.store.getQuotaObject();return this.store.getBytesInUse().pipe(function(a){return e(b).extend({QUOTA_BYTES_IN_USE:a})})},save:function(){var a={};a[this.name]=this.records.join(',');this.store.set(a)},_9:function(){return this.records.map(this._0)},_0:function(a){return this.name+'-'+(e.isString(a)?a:a.id)},_1:function(a){var b={};b[this._0(a)]=JSON.stringify(a);return b},_2:function(a){if(a&&a[this.name]&&e.isString(a[this.name]))return a[this.name].split(',');else return[]}});f.ChromeStorage=j;f.ChromeStorage.Wrapper=l;f.ChromeStorage.sync=f.chromeSync=function(a,b,c,h){var k=b.chromeStorage||b.collection.chromeStorage,d,o=e.isFunction;switch(a){case"read":d=b.id!=null?k.find(b):k.findAll();break;case"create":d=k.create(b);break;case"update":d=k.update(b);break;case"delete":d=k.destroy(b);break;default:var r=new Error('Unknown Method: "'+a+'"');d=i.Deferred();d.reject(d,r.message,r)}if(o(c.success))d.done(c.success);if(o(c.error))d.fail(c.error);if(o(h))d.fail(c.error);return d&&d.promise()};f.ajaxSync=f.sync;f.getSyncMethod=function(a){if(a.chromeStorage||(a.collection&&a.collection.chromeStorage))return f.ChromeStorage.sync;else return f.ajaxSync};f.sync=function(a,b,c,h){return f.getSyncMethod(b).apply(this,[a,b,c,h])};return j}));