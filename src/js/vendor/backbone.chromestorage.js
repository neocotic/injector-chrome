/*! Backbone.ChromeStorage v0.0.2 | (c) 2012 Alexandra Grey | MIT License */
(function(e){typeof define=="function"&&define.amd?define(["jquery","underscore","backbone"],e):e(this.$,this._,this.Backbone)})(function(e,t,n){"use strict";function r(e){e=""+e||"local",chrome.storage[e]||(console.warn("Unknown type %s, defaulting to local",e),e="local"),this.type=e,this.storage=chrome.storage[this.type]}function i(e){return function(){var t=chrome.runtime.lastError;t?(console.warn("chromeStorage error: '%s'",t.message),e.reject(e,t.message,t)):e.resolve.apply(e,arguments)}}function s(t){return function(n){var r=e.Deferred();return typeof n=="function"&&r.done(n),this.storage[t](i(r)),r.promise()}}function o(t){return function(n,r){var s=e.Deferred();return typeof r=="function"&&s.done(r),this.storage[t](n,i(s)),s.promise()}}function u(e,n){t.bindAll.apply(t,[this].concat(t.functions(this))),this.name=e,this.type=n||u.defaultType||"local",this.store=new r(this.type),this.loaded=this.store.get(this.name).pipe(this._parseRecords).done(function(e){this.records=e,chrome.storage.onChanged.addListener(this.updateRecords.bind(this))}.bind(this))}function a(e){return function(){return e.toJSON()}}function f(){return((1+Math.random())*65536|0).toString(16).substring(1)}function l(){return f()+f()+"-"+f()+"-"+f()+"-"+f()+"-"+f()+f()+f()}function c(e){return typeof e=="string"?JSON.parse(e):e}return t(r.prototype).extend({getBytesInUse:s("getBytesInUse"),clear:s("clear"),get:o("get"),set:o("set"),remove:o("remove"),getQuotaObject:function(){return t(this.storage).pick("QUOTA_BYTES","QUOTA_BYTES_PER_ITEM","MAX_ITEMS","MAX_SUSTAINED_WRITE_OPERATIONS_PER_MINUTE","MAX_WRITE_OPERATIONS_PER_HOUR")}}),u.defaultType="local",t(u.prototype).extend({updateRecords:function(e,t){var n=e[this.name];this._recordsChanged(n,t)&&(this.records=n.newValue)},_recordsChanged:function(e,n){return n===this.type&&e?!t.isEqual(e.newValue,this.records):!1},create:function(e){return e.id||(e.id=l(),e.set(e.idAttribute,e.id)),this.store.set(this._wrap(e),this._created.bind(this,e)).pipe(a(e))},_created:function(e){this.records.push(""+e.id),this.save()},update:function(e){return this.store.set(this._wrap(e),this._updated.bind(this,e)).pipe(a(e))},_updated:function(e){var n=""+e.id;t(this.records).include(n)||(this.records.push(n),this.save())},find:function(e){return this.store.get(this._wrap(e)).pipe(this._found.bind(this,e))},_found:function(e,t){return c(t[this._idOf(e)])},findAll:function(){var t=e.Deferred(),n=t.resolve.bind(t);return e.when(this.loaded).done(function(e){var t=this._getRecordIds();this.store.get(t,n)}.bind(this)),t.pipe(this._foundAll)},_foundAll:function(e){return t(e).map(c)},destroy:function(e){return this.store.remove(this._idOf(e),this._destroyed.bind(this,e)).pipe(a(e))},_destroyed:function(e){this.records=t.without(this.records,e.id),this.save()},quota:function(){var e=this.store.getQuotaObject();return this.store.getBytesInUse().pipe(function(n){return t(e).extend({QUOTA_BYTES_IN_USE:n})})},save:function(){var e={};e[this.name]=this.records,this.store.set(e)},_getRecordIds:function(){return this.records.map(this._idOf)},_idOf:function(e){return this.name+"-"+(t.isString(e)?e:e.id)},_wrap:function(e){var n={};return n[this._idOf(e)]=t.isString(e)?e:e.toJSON(),n},_parseRecords:function(e){var n=e&&e[this.name]?e[this.name]:null;return t.isArray(n)?n:typeof n=="string"?(console.debug("[Backbone.ChromeStorage (%s / %s)] upgrading from stringified array of ids",this.type,this.name),n.split(",")):[]}}),n.ChromeStorage=u,n.ChromeStorage.Wrapper=r,n.ChromeStorage.sync=n.chromeSync=function(n,r,i,s){var o=r.chromeStorage||r.collection.chromeStorage,u,a=t.isFunction;switch(n){case"read":u=r.id!=null?o.find(r):o.findAll();break;case"create":u=o.create(r);break;case"update":u=o.update(r);break;case"delete":u=o.destroy(r);break;default:var f=new Error('Unknown Method: "'+n+'"');u=e.Deferred(),u.reject(u,f.message,f)}return a(i.success)&&u.done(i.success),a(i.error)&&u.fail(i.error),a(s)&&u.fail(i.error),u&&u.promise()},n.ajaxSync=n.sync,n.getSyncMethod=function(e){return e.chromeStorage||e.collection&&e.collection.chromeStorage?n.ChromeStorage.sync:n.ajaxSync},n.sync=function(e,t,r,i){return n.getSyncMethod(t).apply(this,[e,t,r,i])},u});